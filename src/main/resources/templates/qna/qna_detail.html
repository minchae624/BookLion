<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>책 먹는 사자 - Q&A 상세</title>
	<link rel="stylesheet" href="/css/style.css" />
	<link rel="stylesheet" href="/css/qna_detail.css" />
	<script th:src="@{/js/frontshared.js}" defer></script>
</head>

<body>
	<header class="home-header">
		<a href="http://localhost:8080/api/home">
			<img src="/img/linklogo.png" alt="홈으로" class="linklogo">
		</a>
		<div class="home-user-info">
			<span id="welcome-msg">환영합니다.</span>
			<div class="home-nav-buttons">
				<a href="/logout" class="btn btn-secondary" id="logout-btn">로그아웃</a>
				<a href="/mypage" class="btn btn-secondary" id="mypage-btn">마이페이지</a>
			</div>
		</div>
	</header>

	<!-- 로그인 유저 정보 -->
	<span id="login-username" style="display: none;" th:if="${loginUser != null}"
		th:text="${loginUser.username}"></span>
	<input type="hidden" id="user-id" th:if="${loginUser != null}" th:value="${loginUser.userId}" />

	<main class="review-detail-container">
		<h3>제목: <span th:text="${question.title}">질문 제목</span></h3>

		<div class="question-wrapper">
			<div class="question-meta">
				<strong>[카테고리]</strong> <span th:text="${question.categoryId}">카테고리</span> |
				<strong>[작성자]</strong> <span th:text="${question.user.username}">작성자</span> |
				<strong>[작성일]</strong> <span
					th:text="${#temporals.format(question.writingtime, 'yyyy-MM-dd')}">작성일</span> |
				<strong>[조회수]</strong> <span th:text="${question.viewCount}">0</span> |
				<strong>[상태]</strong>
				<span th:text="${question.status == 'SOLVED' ? '해결' : '미해결'}"
					th:style="${question.status == 'SOLVED'} ? 'color:green' : 'color:red'">미해결</span>
			</div>

			<!-- 본인 글일 때만 수정/삭제 버튼 -->
			<div class="question-actions" th:if="${loginUser != null and question.user.username == loginUser.username}">
				<a th:href="@{/questions/edit/{id}(id=${question.questId})}" class="btn btn-secondary"
					style="margin-right: 0.5rem;">수정</a>
				<form th:action="@{/questions/delete/{id}(id=${question.questId})}" method="post"
					style="display:inline;">
					<button type="submit" class="btn btn-secondary">삭제</button>
				</form>
			</div>

			<div class="question-content">
				<pre th:text="${question.content}" style="white-space: pre-wrap;">본문 내용</pre>
			</div>
		</div>

		<!-- 좋아요 버튼 (로그인한 사용자만 가능) -->
		<form th:action="@{/questions/{id}/like(id=${question.questId})}" method="post" th:if="${loginUser != null}"
			style="text-align: center; margin-top: 2rem;">
			<button type="submit" class="btn btn-blue">좋아요</button>
		</form>

		<p style="text-align: center; margin-top: 0.5rem;">
			<span th:text="${question.likeCount}">0</span>
		</p>

		<!-- 좋아요 메시지 JS alert 처리 -->
		<div id="message" th:if="${message}" th:data-msg="${message}"></div>

		<script>
			document.addEventListener("DOMContentLoaded", () => {
				const msgDiv = document.getElementById("message");
				if (msgDiv) {
					const message = msgDiv.dataset.msg;
					if (message) {
						alert(message); // 팝업 표시
					}
				}
			});
		</script>

		<!-- 답변 리스트 -->
		<input type="hidden" id="question-id" th:value="${question.questId}" />
		<div id="answer-list" style="margin-top: 2rem;"></div>

		<!-- 답변 작성 -->
		<div style="margin-top: 2rem;">
			<label for="new-answer"><strong>답변 작성</strong></label>
			<textarea id="new-answer" rows="5" class="input-field" placeholder="답변을 입력하세요."></textarea>
			<div style="text-align: right; margin-top: 0.5rem;">
				<button id="btn-submit-answer" class="btn btn-blue">등록</button>
			</div>
		</div>

		<!-- 답변 스크립트 -->
		<script>
			const questionId = document.getElementById("question-id").value;
			const answerListDiv = document.getElementById("answer-list");
			const answerTextarea = document.getElementById("new-answer");
			const answerSubmitBtn = document.getElementById("btn-submit-answer");
			const userId = document.getElementById("user-id")?.value;

			async function loadAnswers() {
				const res = await fetch(`/api/questions/${questionId}/answers`);
				if (!res.ok) {
					answerListDiv.innerHTML = "<p>답변을 불러오는 데 실패했습니다.</p>";
					return;
				}

				const answers = await res.json();
				answerListDiv.innerHTML = "";

				answers.forEach(answer => {
					const div = document.createElement("div");
					div.style = "background-color:#eee; padding:1rem; border-radius:6px; margin-bottom:1rem;";

					let buttons = "";
					if (userId == answer.userId) {
						buttons = `
              <button class="btn-edit" data-id="${answer.answerId}">수정</button>
              <button class="btn-delete" data-id="${answer.answerId}">삭제</button>
            `;
					}

					div.innerHTML = `
            <p style="text-align:right;">${buttons}</p>
            <p><strong>${answer.username}</strong></p>
            <p class="content">${answer.content}</p>
            <p style="text-align:right; font-size:0.9rem;">${new Date(answer.writingtime).toLocaleString()}</p>
          `;
					answerListDiv.appendChild(div);
				});

				setupEditDeleteEvents();
			}

			answerSubmitBtn.addEventListener("click", async () => {
				const content = answerTextarea.value.trim();
				if (!content) return alert("답변을 입력해주세요.");

				const res = await fetch(`/api/questions/${questionId}/answers`, {
					method: "POST",
					headers: {"Content-Type": "application/json"},
					body: JSON.stringify({content, userId: Number(userId)})
				});

				if (res.ok) {
					answerTextarea.value = "";
					loadAnswers();
				} else {
					const err = await res.text();
					alert("등록 실패: " + err);
				}
			});

			function setupEditDeleteEvents() {
				document.querySelectorAll(".btn-edit").forEach(btn => {
					btn.addEventListener("click", async () => {
						const id = btn.dataset.id;
						const div = btn.closest("div");
						const contentP = div.querySelector(".content");

						if (div.querySelector("textarea")) return;

						const textarea = document.createElement("textarea");
						textarea.value = contentP.textContent;
						textarea.style.width = "100%";

						const saveBtn = document.createElement("button");
						saveBtn.textContent = "저장";

						const cancelBtn = document.createElement("button");
						cancelBtn.textContent = "취소";
						cancelBtn.style.marginLeft = "0.5rem";

						contentP.style.display = "none";
						div.append(textarea, saveBtn, cancelBtn);

						saveBtn.addEventListener("click", async () => {
							const newContent = textarea.value.trim();
							const res = await fetch(`/api/answers/${id}`, {
								method: "PUT",
								headers: {"Content-Type": "application/json"},
								body: JSON.stringify({content: newContent})
							});
							if (res.ok) {
								alert("수정 완료");
								loadAnswers();
							} else {
								alert("수정 실패");
							}
						});

						cancelBtn.addEventListener("click", () => {
							textarea.remove();
							saveBtn.remove();
							cancelBtn.remove();
							contentP.style.display = "block";
						});
					});
				});

				document.querySelectorAll(".btn-delete").forEach(btn => {
					btn.addEventListener("click", async () => {
						const id = btn.dataset.id;
						if (!confirm("정말 삭제하시겠습니까?")) return;
						const res = await fetch(`/api/answers/${id}`, {method: "DELETE"});
						if (res.ok) {
							alert("삭제 완료");
							loadAnswers();
						} else {
							alert("삭제 실패");
						}
					});
				});
			}

			document.addEventListener("DOMContentLoaded", loadAnswers);
		</script>
	</main>
</body>

</html>